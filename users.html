{% extends "base.html" %}

{% block title %}إدارة المستخدمين - نظام إدارة السوبر ماركت{% endblock %}

{% block content %}
<div class="users-container">
    <!-- رأس الصفحة -->
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="page-title">
                    <i class="fas fa-users me-2"></i>
                    إدارة المستخدمين
                </h2>
                <p class="page-subtitle">إدارة حسابات المستخدمين والصلاحيات</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="fas fa-plus me-2"></i>
                    إضافة مستخدم جديد
                </button>
            </div>
        </div>
    </div>

    <!-- إحصائيات المستخدمين -->
    <div class="users-stats">
        <div class="row">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card stat-primary">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-value">{{ total_users or 0 }}</h3>
                        <p class="stat-label">إجمالي المستخدمين</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card stat-success">
                    <div class="stat-icon">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-value">{{ active_users or 0 }}</h3>
                        <p class="stat-label">المستخدمين النشطين</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card stat-warning">
                    <div class="stat-icon">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-value">{{ admin_users or 0 }}</h3>
                        <p class="stat-label">المديرين</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card stat-info">
                    <div class="stat-icon">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-content">
                        <h3 class="stat-value">{{ cashier_users or 0 }}</h3>
                        <p class="stat-label">الكاشيرين</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- فلاتر البحث -->
    <div class="filters-section">
        <div class="row">
            <div class="col-md-4">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" class="form-control" id="userSearch" 
                           placeholder="ابحث عن مستخدم...">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="roleFilter">
                    <option value="">جميع الأدوار</option>
                    <option value="admin">مدير</option>
                    <option value="manager">مدير فرع</option>
                    <option value="cashier">كاشير</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="">جميع الحالات</option>
                    <option value="active">نشط</option>
                    <option value="inactive">غير نشط</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-primary w-100" onclick="filterUsers()">
                    <i class="fas fa-filter me-2"></i>
                    فلترة
                </button>
            </div>
        </div>
    </div>

    <!-- جدول المستخدمين -->
    <div class="users-table-section">
        <div class="table-card">
            <div class="table-header">
                <h5>
                    <i class="fas fa-list me-2"></i>
                    قائمة المستخدمين
                </h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>الصورة</th>
                            <th>اسم المستخدم</th>
                            <th>البريد الإلكتروني</th>
                            <th>الدور</th>
                            <th>الحالة</th>
                            <th>تاريخ الإنشاء</th>
                            <th>آخر دخول</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        {% for user in users %}
                        <tr>
                            <td>
                                <div class="user-avatar">
                                    <img src="{{ user.avatar_url or '/static/images/default-avatar.svg' }}" 
                                         alt="{{ user.username }}">
                                </div>
                            </td>
                            <td>
                                <div class="user-info">
                                    <h6 class="user-name">{{ user.username }}</h6>
                                    <small class="user-id">ID: {{ user.id }}</small>
                                </div>
                            </td>
                            <td>{{ user.email or 'غير محدد' }}</td>
                            <td>
                                <span class="role-badge role-{{ user.role }}">
                                    {% if user.role == 'admin' %}
                                        مدير
                                    {% elif user.role == 'manager' %}
                                        مدير فرع
                                    {% elif user.role == 'cashier' %}
                                        كاشير
                                    {% else %}
                                        {{ user.role }}
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge status-{{ 'active' if user.is_active else 'inactive' }}">
                                    {{ 'نشط' if user.is_active else 'غير نشط' }}
                                </span>
                            </td>
                            <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'غير محدد' }}</td>
                            <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'لم يدخل بعد' }}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="editUser({{ user.id }})" title="تعديل">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" 
                                            onclick="resetPassword({{ user.id }})" title="إعادة تعيين كلمة المرور">
                                        <i class="fas fa-key"></i>
                                    </button>
                                    {% if user.id != current_user.id %}
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="toggleUserStatus({{ user.id }})" 
                                            title="{{ 'إلغاء التفعيل' if user.is_active else 'تفعيل' }}">
                                        <i class="fas fa-{{ 'ban' if user.is_active else 'check' }}"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-users fa-3x mb-3"></i>
                                <p>لا توجد مستخدمين</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- الترقيم -->
    {% if users.pages > 1 %}
    <div class="pagination-section">
        <nav aria-label="ترقيم المستخدمين">
            <ul class="pagination justify-content-center">
                {% if users.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('users', page=users.prev_num) }}">السابق</a>
                </li>
                {% endif %}
                
                {% for page_num in users.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != users.page %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('users', page=page_num) }}">{{ page_num }}</a>
                        </li>
                        {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% endif %}
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if users.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('users', page=users.next_num) }}">التالي</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
</div>

<!-- نافذة إضافة مستخدم -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">إضافة مستخدم جديد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUserForm" method="POST" action="{{ url_for('add_user') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">اسم المستخدم *</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">البريد الإلكتروني</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">كلمة المرور *</label>
                            <input type="password" class="form-control" name="password" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">تأكيد كلمة المرور *</label>
                            <input type="password" class="form-control" name="confirm_password" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">الدور *</label>
                            <select class="form-select" name="role" required>
                                <option value="">اختر الدور</option>
                                <option value="admin">مدير</option>
                                <option value="manager">مدير فرع</option>
                                <option value="cashier">كاشير</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">الحالة</label>
                            <select class="form-select" name="is_active">
                                <option value="1">نشط</option>
                                <option value="0">غير نشط</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">إضافة المستخدم</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- نافذة تعديل مستخدم -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تعديل المستخدم</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <!-- سيتم ملؤها بـ JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ التغييرات</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// فلترة المستخدمين
function filterUsers() {
    const search = document.getElementById('userSearch').value;
    const role = document.getElementById('roleFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    // إعادة توجيه مع المعاملات
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (role) params.append('role', role);
    if (status) params.append('status', status);
    
    window.location.href = '{{ url_for("users") }}?' + params.toString();
}

// تعديل مستخدم
function editUser(userId) {
    // سيتم تنفيذها لاحقاً
    console.log('Edit user:', userId);
}

// إعادة تعيين كلمة المرور
function resetPassword(userId) {
    if (confirm('هل أنت متأكد من إعادة تعيين كلمة المرور؟')) {
        // سيتم تنفيذها لاحقاً
        console.log('Reset password for user:', userId);
    }
}

// تغيير حالة المستخدم
function toggleUserStatus(userId) {
    if (confirm('هل أنت متأكد من تغيير حالة المستخدم؟')) {
        // سيتم تنفيذها لاحقاً
        console.log('Toggle status for user:', userId);
    }
}

// البحث المباشر
document.getElementById('userSearch').addEventListener('input', function() {
    // سيتم تنفيذها لاحقاً للبحث المباشر
});
</script>
{% endblock %}
