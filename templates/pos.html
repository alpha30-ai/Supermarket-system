{% extends "base.html" %}

{% block title %}نقطة البيع - نظام إدارة السوبر ماركت{% endblock %}

{% block content %}
<div class="pos-container">
    <!-- رأس نقطة البيع -->
    <div class="pos-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2 class="pos-title">
                    <i class="fas fa-cash-register me-2"></i>
                    نقطة البيع
                </h2>
                <p class="pos-subtitle">إدارة المبيعات والفواتير</p>
            </div>
            <div class="col-md-6 text-end">
                <div class="pos-info">
                    <div class="cashier-info">
                        <i class="fas fa-user me-2"></i>
                        <span>الكاشير: {{ current_user.username }}</span>
                    </div>
                    <div class="date-info">
                        <i class="fas fa-calendar me-2"></i>
                        <span id="current-date-pos"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- قسم البحث والمنتجات -->
        <div class="col-lg-8">
            <div class="products-section">
                <!-- شريط البحث -->
                <div class="search-section">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" class="form-control" id="productSearch" 
                                       placeholder="ابحث عن منتج بالاسم أو الباركود...">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="categoryFilter">
                                <option value="">جميع الفئات</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- شبكة المنتجات -->
                <div class="products-grid" id="productsGrid">
                    {% for product in products %}
                    <div class="product-card" data-product-id="{{ product.id }}" onclick="addToCart({{ product.id }})">
                        <div class="product-image">
                            <img src="{{ product.image_url or '/static/images/default-product.svg' }}" alt="{{ product.name }}">
                        </div>
                        <div class="product-info">
                            <h6 class="product-name">{{ product.name }}</h6>
                            <p class="product-price">{{ "%.2f"|format(product.sale_price) }} ج.م</p>
                            <div class="product-stock">
                                {% if product.stock_quantity > 0 %}
                                    <span class="stock-available">متوفر ({{ product.stock_quantity }})</span>
                                {% else %}
                                    <span class="stock-unavailable">نفد المخزون</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- قسم السلة والفاتورة -->
        <div class="col-lg-4">
            <div class="cart-section">
                <!-- رأس السلة -->
                <div class="cart-header">
                    <h4>
                        <i class="fas fa-shopping-cart me-2"></i>
                        السلة
                        <span class="cart-count" id="cartCount">0</span>
                    </h4>
                    <button class="btn btn-outline-danger btn-sm" onclick="clearCart()">
                        <i class="fas fa-trash"></i>
                        مسح الكل
                    </button>
                </div>

                <!-- عناصر السلة -->
                <div class="cart-items" id="cartItems">
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart fa-3x"></i>
                        <p>السلة فارغة</p>
                        <small>ابدأ بإضافة المنتجات</small>
                    </div>
                </div>

                <!-- ملخص الفاتورة -->
                <div class="invoice-summary">
                    <div class="summary-row">
                        <span>المجموع الفرعي:</span>
                        <span id="subtotal">0.00 ج.م</span>
                    </div>
                    <div class="summary-row">
                        <span>الضريبة (14%):</span>
                        <span id="tax">0.00 ج.م</span>
                    </div>
                    <div class="summary-row">
                        <span>الخصم:</span>
                        <span id="discount">0.00 ج.م</span>
                    </div>
                    <hr>
                    <div class="summary-row total">
                        <span>الإجمالي:</span>
                        <span id="total">0.00 ج.م</span>
                    </div>
                </div>

                <!-- خيارات الدفع -->
                <div class="payment-section">
                    <div class="payment-method">
                        <label class="form-label">طريقة الدفع:</label>
                        <select class="form-select" id="paymentMethod">
                            <option value="cash">نقدي</option>
                            <option value="card">بطاقة ائتمان</option>
                            <option value="mixed">مختلط</option>
                        </select>
                    </div>

                    <div class="payment-amount">
                        <label class="form-label">المبلغ المدفوع:</label>
                        <input type="number" class="form-control" id="paidAmount" step="0.01" placeholder="0.00">
                    </div>

                    <div class="change-amount">
                        <label class="form-label">الباقي:</label>
                        <input type="text" class="form-control" id="changeAmount" readonly>
                    </div>
                </div>

                <!-- اختيار العميل -->
                <div class="customer-section mb-3">
                    <label for="customer-select" class="form-label">العميل (اختياري)</label>
                    <select class="form-select" id="customer-select">
                        <option value="">عميل عادي</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }} - {{ customer.phone }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- طريقة الدفع -->
                <div class="payment-section mb-3">
                    <label class="form-label">طريقة الدفع</label>
                    <div class="payment-methods">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="cash" value="cash" checked>
                            <label class="form-check-label" for="cash">
                                <i class="fas fa-money-bill-wave me-2"></i>نقدي
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="card" value="card">
                            <label class="form-check-label" for="card">
                                <i class="fas fa-credit-card me-2"></i>بطاقة
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="payment_method" id="mixed" value="mixed">
                            <label class="form-check-label" for="mixed">
                                <i class="fas fa-coins me-2"></i>مختلط
                            </label>
                        </div>
                    </div>
                </div>

                <!-- أزرار العمليات -->
                <div class="action-buttons">
                    <button class="btn btn-success btn-lg w-100 mb-2" onclick="completeSale()" id="completeSaleBtn" disabled>
                        <i class="fas fa-check me-2"></i>
                        إتمام البيع
                    </button>
                    <div class="row">
                        <div class="col-6">
                            <button class="btn btn-outline-primary w-100" onclick="holdSale()">
                                <i class="fas fa-pause me-2"></i>
                                تعليق
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-info w-100" onclick="printInvoice()">
                                <i class="fas fa-print me-2"></i>
                                طباعة
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- نافذة تأكيد البيع -->
<div class="modal fade" id="saleConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">تأكيد البيع</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="sale-summary">
                    <h6>ملخص البيع:</h6>
                    <div class="summary-details" id="saleModalSummary">
                        <!-- سيتم ملؤها بـ JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-success" onclick="confirmSale()">تأكيد البيع</button>
            </div>
        </div>
    </div>
</div>

<!-- نافذة إضافة خصم -->
<div class="modal fade" id="discountModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">إضافة خصم</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">نوع الخصم:</label>
                    <select class="form-select" id="discountType">
                        <option value="percentage">نسبة مئوية</option>
                        <option value="fixed">مبلغ ثابت</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">قيمة الخصم:</label>
                    <input type="number" class="form-control" id="discountValue" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="applyDiscount()">تطبيق الخصم</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// متغيرات السلة
let cart = [];
let currentSale = {
    subtotal: 0,
    tax: 0,
    discount: 0,
    total: 0
};

// تحديث التاريخ
function updatePOSDate() {
    const now = new Date();
    const options = {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    document.getElementById('current-date-pos').textContent = now.toLocaleDateString('ar-EG', options);
}

// إضافة منتج للسلة
function addToCart(productId) {
    const productCard = document.querySelector(`[data-product-id="${productId}"]`);
    const productName = productCard.querySelector('.product-name').textContent;
    const productPrice = parseFloat(productCard.querySelector('.product-price').textContent);

    // البحث عن المنتج في السلة
    const existingItem = cart.find(item => item.product_id === productId);

    if (existingItem) {
        existingItem.quantity += 1;
        existingItem.total = existingItem.quantity * existingItem.price;
    } else {
        cart.push({
            product_id: productId,
            name: productName,
            price: productPrice,
            quantity: 1,
            total: productPrice
        });
    }

    updateCartDisplay();
    updateSummary();
}

// مسح السلة
function clearCart() {
    cart = [];
    updateCartDisplay();
    updateSummary();
}

// تحديث عرض السلة
function updateCartDisplay() {
    const cartItems = document.getElementById('cart-items');
    cartItems.innerHTML = '';

    cart.forEach((item, index) => {
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
            <div class="item-info">
                <h6 class="item-name">${item.name}</h6>
                <div class="item-controls">
                    <button class="btn btn-sm btn-outline-secondary" onclick="decreaseQuantity(${index})">-</button>
                    <span class="quantity">${item.quantity}</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="increaseQuantity(${index})">+</button>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeFromCart(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="item-price">
                <span class="unit-price">${item.price.toFixed(2)} ج.م</span>
                <span class="total-price">${item.total.toFixed(2)} ج.م</span>
            </div>
        `;
        cartItems.appendChild(cartItem);
    });
}

// زيادة الكمية
function increaseQuantity(index) {
    cart[index].quantity += 1;
    cart[index].total = cart[index].quantity * cart[index].price;
    updateCartDisplay();
    updateSummary();
}

// تقليل الكمية
function decreaseQuantity(index) {
    if (cart[index].quantity > 1) {
        cart[index].quantity -= 1;
        cart[index].total = cart[index].quantity * cart[index].price;
        updateCartDisplay();
        updateSummary();
    }
}

// حذف من السلة
function removeFromCart(index) {
    cart.splice(index, 1);
    updateCartDisplay();
    updateSummary();
}

// تحديث الملخص
function updateSummary() {
    const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
    const tax = subtotal * 0.14; // ضريبة 14%
    const total = subtotal + tax;

    document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' ج.م';
    document.getElementById('tax').textContent = tax.toFixed(2) + ' ج.م';
    document.getElementById('total').textContent = total.toFixed(2) + ' ج.م';

    updateCompleteSaleButton();
}

// تحديث حالة زر إتمام البيع
function updateCompleteSaleButton() {
    const completeSaleBtn = document.getElementById('completeSaleBtn');
    if (cart.length > 0) {
        completeSaleBtn.disabled = false;
        completeSaleBtn.classList.remove('btn-secondary');
        completeSaleBtn.classList.add('btn-success');
    } else {
        completeSaleBtn.disabled = true;
        completeSaleBtn.classList.remove('btn-success');
        completeSaleBtn.classList.add('btn-secondary');
    }
}

// إتمام البيع
function completeSale() {
    if (cart.length === 0) {
        alert('السلة فارغة');
        return;
    }

    const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
    const customerId = document.getElementById('customer-select').value || null;

    const saleData = {
        items: cart,
        payment_method: paymentMethod,
        customer_id: customerId
    };

    fetch('/api/pos/complete_sale', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(saleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('تم إتمام البيع بنجاح');
            clearCart();
            printInvoice(data.sale_id);
        } else {
            alert('خطأ: ' + data.message);
        }
    })
    .catch(error => {
        alert('حدث خطأ أثناء إتمام البيع');
    });
}

// طباعة الفاتورة
function printInvoice(saleId) {
    const printWindow = window.open('', '_blank');
    const subtotal = cart.reduce((sum, item) => sum + item.total, 0);
    const tax = subtotal * 0.14;
    const total = subtotal + tax;

    printWindow.document.write(`
        <html>
        <head>
            <title>فاتورة رقم ${saleId}</title>
            <style>
                body { font-family: Arial, sans-serif; direction: rtl; }
                .header { text-align: center; margin-bottom: 20px; }
                .invoice-details { margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                th { background-color: #f2f2f2; }
                .total { font-weight: bold; }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>سوبر ماركت</h2>
                <p>فاتورة رقم: ${saleId}</p>
                <p>التاريخ: ${new Date().toLocaleDateString('ar-EG')}</p>
                <p>الكاشير: {{ current_user.username }}</p>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>المنتج</th>
                        <th>الكمية</th>
                        <th>السعر</th>
                        <th>المجموع</th>
                    </tr>
                </thead>
                <tbody>
                    ${cart.map(item => `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.quantity}</td>
                            <td>${item.price.toFixed(2)} ج.م</td>
                            <td>${item.total.toFixed(2)} ج.م</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            <div style="margin-top: 20px;">
                <p>المجموع الفرعي: ${subtotal.toFixed(2)} ج.م</p>
                <p>الضريبة (14%): ${tax.toFixed(2)} ج.م</p>
                <p class="total">المجموع الكلي: ${total.toFixed(2)} ج.م</p>
            </div>
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.print();
}

// تهيئة الصفحة
document.addEventListener('DOMContentLoaded', function() {
    updatePOSDate();
    setInterval(updatePOSDate, 60000); // تحديث كل دقيقة
});
</script>
{% endblock %}
