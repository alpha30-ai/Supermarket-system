{% extends "base.html" %}

{% block title %}الملف الشخصي{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="profile-header">
                <div class="d-flex align-items-center">
                    <div class="profile-avatar me-4">
                        <img src="{{ user.avatar_url or '/static/images/default-avatar.svg' }}" 
                             alt="صورة المستخدم" class="avatar-img">
                        <div class="avatar-status"></div>
                    </div>
                    <div class="profile-info">
                        <h2 class="profile-name">{{ user.username }}</h2>
                        <p class="profile-role">
                            <i class="fas fa-user-tag me-2"></i>
                            {% if user.role == 'admin' %}
                                مدير النظام
                            {% elif user.role == 'manager' %}
                                مدير
                            {% else %}
                                كاشير
                            {% endif %}
                        </p>
                        <p class="profile-email">
                            <i class="fas fa-envelope me-2"></i>
                            {{ user.email or 'لم يتم تحديد البريد الإلكتروني' }}
                        </p>
                        <p class="profile-date">
                            <i class="fas fa-calendar-alt me-2"></i>
                            عضو منذ {{ user.created_at.strftime('%d/%m/%Y') }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Content -->
    <div class="row">
        <!-- Profile Settings -->
        <div class="col-lg-8">
            <div class="card profile-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-edit me-2"></i>
                        تحديث الملف الشخصي
                    </h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('update_profile') }}" method="POST" id="profileForm">
                        <!-- Basic Information -->
                        <div class="section-title">
                            <h6><i class="fas fa-info-circle me-2"></i>المعلومات الأساسية</h6>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="username" class="form-label">اسم المستخدم</label>
                                <input type="text" class="form-control" id="username" 
                                       value="{{ user.username }}" readonly>
                                <small class="text-muted">لا يمكن تغيير اسم المستخدم</small>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">البريد الإلكتروني</label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="{{ user.email or '' }}" placeholder="أدخل البريد الإلكتروني">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="role" class="form-label">الدور</label>
                                <input type="text" class="form-control" id="role" 
                                       value="{% if user.role == 'admin' %}مدير النظام{% elif user.role == 'manager' %}مدير{% else %}كاشير{% endif %}" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="last_login" class="form-label">آخر دخول</label>
                                <input type="text" class="form-control" id="last_login" 
                                       value="{% if user.last_login %}{{ user.last_login.strftime('%d/%m/%Y %H:%M') }}{% else %}لم يتم تسجيل دخول من قبل{% endif %}" readonly>
                            </div>
                        </div>

                        <!-- Password Change -->
                        <div class="section-title mt-4">
                            <h6><i class="fas fa-lock me-2"></i>تغيير كلمة المرور</h6>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="current_password" class="form-label">كلمة المرور الحالية</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="current_password" 
                                           name="current_password" placeholder="أدخل كلمة المرور الحالية">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('current_password')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="new_password" class="form-label">كلمة المرور الجديدة</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="new_password" 
                                           name="new_password" placeholder="أدخل كلمة المرور الجديدة">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('new_password')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">يجب أن تكون 6 أحرف على الأقل</small>
                            </div>
                            <div class="col-md-6">
                                <label for="confirm_password" class="form-label">تأكيد كلمة المرور</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="confirm_password" 
                                           name="confirm_password" placeholder="أعد إدخال كلمة المرور الجديدة">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirm_password')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-flex justify-content-end mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>
                                حفظ التغييرات
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Profile Statistics -->
        <div class="col-lg-4">
            <div class="card profile-stats-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        إحصائيات الحساب
                    </h5>
                </div>
                <div class="card-body">
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-info">
                            <h6>مدة العضوية</h6>
                            <p id="membershipDays">حساب المدة...</p>
                        </div>
                    </div>

                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h6>آخر نشاط</h6>
                            <p>{% if user.last_login %}{{ user.last_login.strftime('%d/%m/%Y') }}{% else %}غير محدد{% endif %}</p>
                        </div>
                    </div>

                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h6>مستوى الأمان</h6>
                            <p>عالي</p>
                        </div>
                    </div>

                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="stat-info">
                            <h6>حالة الحساب</h6>
                            <p class="text-success">نشط</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>
                        إجراءات سريعة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            لوحة التحكم
                        </a>
                        {% if user.role == 'admin' %}
                        <a href="{{ url_for('users') }}" class="btn btn-outline-info">
                            <i class="fas fa-users me-2"></i>
                            إدارة المستخدمين
                        </a>
                        <a href="{{ url_for('backup') }}" class="btn btn-outline-warning">
                            <i class="fas fa-download me-2"></i>
                            النسخ الاحتياطي
                        </a>
                        {% endif %}
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                            <i class="fas fa-sign-out-alt me-2"></i>
                            تسجيل الخروج
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Calculate membership days
document.addEventListener('DOMContentLoaded', function() {
    const createdAt = new Date('{{ user.created_at.isoformat() }}');
    const now = new Date();
    const diffTime = Math.abs(now - createdAt);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    document.getElementById('membershipDays').textContent = diffDays + ' يوم';
});

function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = field.nextElementSibling.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Form validation
document.getElementById('profileForm').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const currentPassword = document.getElementById('current_password').value;
    
    if (newPassword || confirmPassword) {
        if (!currentPassword) {
            e.preventDefault();
            alert('يجب إدخال كلمة المرور الحالية لتغيير كلمة المرور');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            alert('كلمة المرور الجديدة وتأكيدها غير متطابقين');
            return;
        }
        
        if (newPassword.length < 6) {
            e.preventDefault();
            alert('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
            return;
        }
    }
});
</script>
{% endblock %}
